"use strict";(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[998],{98998:(Xe,le,p)=>{p.r(le),p.d(le,{CopilotChatService:()=>D,CopilotModule:()=>H});var m=p(84911),l=p(55069),T=p(30660),o=p(36599),v=p(37686),h=p(78519),De=p(7403),c=p(33376),C=p(27969),E=p(26903),z=p(33568),Te=p(44551);const de=new o.InjectionToken("OptionsSkipUnsuccessfulResponseHandling"),he=new o.InjectionToken("SchemaDesignerApiUrl");class R{constructor(e){e&&(this.uId=e.uId,this.name=e.name,this.parentSchemaUId=e.parentSchemaUId),this.uId=this.uId||(0,l.generateGuid)()}update(e){this.uId=e.uId,this.name=e.name}equal(e){if(e==null)return!1;let t=this.uId===e.uId&&this.name===e.name;return(this.parentSchemaUId||e.parentSchemaUId)&&(t=t&&this.parentSchemaUId===e.parentSchemaUId),t}clone(){return new R(this)}getLocalizableValues(e){}loadLocalizableValues(e,t=!1){}}class j{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new j(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class Re extends R{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new j(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let a=t.requiredSchemas;a&&(a=[...a]);let s=t.requiredEntityColumns;s&&(s=s.map(n=>({entitySchemaName:n.entitySchemaName,columnPaths:[...n.columnPaths]}))),this.dependencies={requiredSchemas:a,requiredEntityColumns:s}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class et extends null{constructor(e){super(e),e&&(this.caption=e.caption)}}class tt extends null{}class V extends R{constructor(e){super(e),this.values=new h.CjD(e?.values)}clone(){return new V(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.values=this.values.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.values.setValues(e.values,t)}}class x extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,l.generateGuid)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const a=e?.findItem(t.uId);return t.equal(a)})}clone(){return new x(this)}getLocalizableValues(e,t){this.forEach(a=>{const s={};a.getLocalizableValues(s),Object.entries(s).forEach(([n,r])=>{e[`${t}.${a.name}.${n}`]=r})})}loadLocalizableValues(e,t,a=!1){const s={};Object.entries(e).map(([n,r])=>{const d=n.split("."),I=d.shift(),u=d.shift(),S=d.join(".");return{itemGroupName:I,itemName:u,itemResourceName:S,values:r}}).filter(({itemGroupName:n})=>n===t).forEach(({itemName:n,itemResourceName:r,values:d})=>{const I=s[n]??{};I[r]=d,s[n]=I}),Object.entries(s).forEach(([n,r])=>{this.find(I=>I.name===n).loadLocalizableValues(r,a)})}}class k extends Re{constructor(e){super(e),this.caption=new h.CjD,this.description=new h.CjD,this.localizableStrings=new x,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new h.CjD(e.caption),this.description=new h.CjD(e.description)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}equal(e){return e==null?!1:super.equal(e)&&(0,h.DGp)(this.caption,e.caption,!0)&&(0,h.DGp)(this.description,e.description,!0)}clone(){return new k(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}}const ue=new o.InjectionToken("SchemaDesignerConverter");class F extends null{constructor(e){super(e),this.isChanged=!1,e&&(this._data=e.data||{},this.image=e.image,this.caption=new LocalizableStringArray(e.caption)),this.caption||(this.caption=new LocalizableStringArray)}get data(){return this._data}get image(){return this.data?.name}set image(e){!e||e===this.data?.name||Object.assign(this._data,{name:e})}static _getIsFileChanged(e,t){const a=e?.name,s=t?.name,n=a&&!s,r=s&&!a,d=s&&a&&t.size>0;return r||n||d}updateFile(e){this.isChanged=F._getIsFileChanged(this.data,e),this._data=e}clone(){return new F(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t)}}class pe extends null{_findNestedProperties(e,t){const a=t.find(s=>s.uId===e);return a?a.itemProperties:null}_getNestedParametersGroup(e,t){return findCollectionRecursive(t,a=>this._findNestedProperties(e,a),a=>a.itemProperties)}_getParametersGroup(e,t){let a=this._getNestedParametersGroup(e,t);return a||(a=this.parameters.uId===e?this.parameters:null),a}_getParameter(e,t){return findItemRecursive(t,a=>a.uId===e,a=>a.itemProperties)}constructor(e){super(e),this.parameters=new MetaItemArray,e&&(this.parameters=e.parameters.clone())}findChildrenItem(e){return this._getParameter(e,this.parameters)||super.findChildrenItem(e)}findGroup(e){const t=this._getParametersGroup(e,this.parameters);return t||super.findGroup(e)}findNestedParametersGroup(e){return this._getNestedParametersGroup(e,this.parameters)||this.parameters}findParameterByUId(e){return this._getParameter(e,this.parameters)}clone(){return new pe(this)}getLocalizableValues(e){super.getLocalizableValues(e),this.parameters.getLocalizableValues(e,"parameters")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.parameters.loadLocalizableValues(e,"parameters",t)}}class L extends null{constructor(e){super(e),e&&(this.caption=new LocalizableStringArray(e.caption),this.type=e.type,this.lookup=e.lookup,this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value,this.itemProperties=this._mapItemArray(e.itemProperties))}static updateLookupValue(e,t,a){const s=e[a]?e[a].key:null;s?t[a]=s:delete t[a]}_getSourceType(e){return e.type?.key}_mapItemArray(e){return e?new MetaItemArray(e.map(t=>new L(t))):new MetaItemArray}_resetItemProperties(e){this.type!==e&&(this.itemProperties=new MetaItemArray,this.itemProperties.uId=this.uId)}updateDescription(e){this.caption=e.caption,this.name=e.name;const t=this._getSourceType(e);this._resetItemProperties(t),this.type=t,L.updateLookupValue(e,this,"lookup"),this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value}clone(){return new L(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),this.itemProperties.getLocalizableValues(e,"itemProperties")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.itemProperties.loadLocalizableValues(e,"itemProperties",t)}}var me=p(79701),ge=p(98168);class O extends h.Pp5{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources}clone(){return new O(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class w{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,l.generateGuid)(),e[0]instanceof w){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get schema$(){return this._isLoaded?(0,c.of)(this._schema):this._loadSchema()}get addonConfig(){return this.schema$.pipe((0,C.U)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,c.forkJoin)([this.schema$,e]).subscribe(([t,a])=>{t.addonConfig=a,this._isChanged=!0})}get isChanged(){return this._isChanged}get resources(){return this._resources}_setMetadataDefValues(e){this.addonName===h.nM_.BusinessRule&&e.rules?.forEach(a=>{a.name=a.name||(0,me.FP)(),a.enabled=a.enabled||a.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const a=t.key.split(".");return{key:[a[2],a[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,ge.b)(e=>{e.success&&(this._schema=new O(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,C.U)(()=>this._schema),(0,E.B)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,C.U)(e=>e.success),(0,ge.b)(()=>{this._isChanged=!1})):(0,c.of)(!0)}clone(){return new w(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(a=>a.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(a=>a.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}var A=(()=>(function(i){i[i.NO=0]="NO",i[i.YES=1]="YES"}(A||(A={})),A))();const at={[A.NO]:{type:A.NO,name:"No"},[A.YES]:{type:A.YES,name:"Yes"}};let Se=(()=>{class i{constructor(t){this.getAddonMethodName="GetSchema",this.saveAddonMethodName="SaveSchema",this.serviceEndpoint="/ServiceModel/AddonSchemaDesignerService.svc/",this._httpClient=t.get(v.HttpClient),this._workplaceService=t.get(h.jAR)}getAddon(t){const a=`${this.serviceEndpoint}${this.getAddonMethodName}`;return this._httpClient.post(a,t)}saveAddon(t){const a=`${this.serviceEndpoint}${this.saveAddonMethodName}`;return this._httpClient.post(a,t).pipe((0,c.switchMap)(s=>this._workplaceService.resetWorkplaceScriptCache().pipe((0,C.U)(()=>s))))}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(o.Injector))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})(),Ie=(()=>{class i{constructor(t){this._apiService=t.get(Se),this._features=t.get(h.Sfm,{optional:!0})}_getParentSchemaUId(t){const a=t.parentSchema??t.parent;return a?.name===t.name?a.uId:l.EMPTY_GUID}create(t,a){return!t.addonTypes||t.addonTypes.length===0?[]:t.addonTypes.map(s=>{const n=this._getParentSchemaUId(t);return this.createAddonInfo(t,s,n,a)})}createAddonInfo(t,a,s,n){return new w(a,t.uId,s,t.package.uId,n,this._apiService,t.useFullHierarchy)}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(o.Injector))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})();const je=i=>`/ServiceModel/${i}/`,Le=(i,e)=>({multi:!1,provide:e,useValue:je(i)}),we=i=>Le(i,he);let He=(()=>{class i{constructor(t){this._restErrorHandleOptions={},this.createNewSchemaMethodName="CreateNewSchema",this.getSchemaMethodName="GetSchema",this.saveSchemaMethodName="SaveSchema",this.httpClient=t.get(v.HttpClient),this.serviceEndpoint=t.get(he),this._converter=t.get(ue,null,{optional:!0}),this._addonInfoFactory=t.get(Ie),this._errorHandler=t.get(h.ZsW),this._restErrorHandleOptions.skipUnsuccessfulResponse=t.get(de,!1,{optional:!0})}get converter(){return this._converter}getSchemaManagerName(){return null}getSchemaFromService(t,a,s=!1){const n=s?{headers:new v.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(t,a,n).pipe((0,C.U)(r=>{if(r.schema){const d=this.getSchemaManagerName();return r.schema=this.convertToObject(r.schema),r.schema.addons=this._addonInfoFactory.create(r.schema,d),r}return r}),(0,E.B)())}getSchemasFromService(t,a,s=!1){const n=s?{headers:new v.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(t,a,n).pipe((0,C.U)(r=>{if(r.schemas){const d=this.getSchemaManagerName();return r.schemas.forEach((I,u)=>{r.schemas[u]=this.convertToObject(I),r.schemas[u].addons=this._addonInfoFactory.create(I,d)}),r}return r}),(0,E.B)())}createObject(t,a){return Object.assign(new t,a)}convertToObject(t){return this._converter.convertToSchema(t)}convertSchemaToDTO(t){return t}_addonSaveHandler(t){const a=t.save();return this._errorHandler.handleRequest(a,this._restErrorHandleOptions).pipe((0,z.K)(()=>(0,c.of)(!1)),(0,C.U)(s=>({message:`Addon ${t.addonName} was ${s?"successfully":"not"} saved!`,result:s})))}_saveAddons(t){return(0,c.forkJoin)(t.map(a=>this._addonSaveHandler(a))).pipe((0,C.U)(a=>{const s=a.filter(n=>!n.result).map(n=>n.message);return s.length>0?s:null}))}createSchema(t){const a=`${this.serviceEndpoint}${this.createNewSchemaMethodName}`;return this.getSchemaFromService(a,t)}getSchema(t){const a=`${this.serviceEndpoint}${this.getSchemaMethodName}`;return this.getSchemaFromService(a,t)}saveSchema(t,a=!1){a&&(t.useFullHierarchy=!0);const s=`${this.serviceEndpoint}${this.saveSchemaMethodName}`,n=t.addons?[...t.addons]:null,r=(0,De.Z)(t,["addons"]),d=this.httpClient.post(s,r);return this._errorHandler.handleRequest(d,this._restErrorHandleOptions).pipe((0,Te.b)(u=>{const S=n?.filter(y=>y.isChanged);return u.success&&S?.length>0?this._saveAddons(S).pipe((0,C.U)(y=>({...u,addonsErrors:y}))):(0,c.of)(u)}),(0,E.B)())}checkUniqueSchemaName(t,a,s){const n=this.serviceEndpoint+"CheckUniqueSchemaName",r={schemaName:t,excludeUId:a,managerName:s};return this.httpClient.post(n,r,{headers:new v.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,E.B)())}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(o.Injector))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();class ze{constructor(e){this.factory=e}createSchema(e){const t=new this.factory;return Object.assign(t,e),e.package&&(t.package=new j(e.package.name,e.package.uId),t.package.type=e.package.type,t.package.isChanged=e.package.isChanged,t.package.isLocked=e.package.isLocked),t}createLocalizableStrings(e){if(!e)return new x;const t=e.map(a=>new V(a));return new x(t)}}const Ve=new o.InjectionToken("SchemaImageUploaderApiUrl"),st=i=>({multi:!1,provide:Ve,useValue:`/ServiceModel/${i}`});let it=null,nt=null,ke=(()=>{class i{constructor(t){this._httpClient=t,this._appInstallerServiceUrl="ServiceModel/AppInstallerService.svc/",this._getDesignPackageUId="GetDesignPackageUId"}getDesignPackageUId(t){const a=`${this._appInstallerServiceUrl}${this._getDesignPackageUId}`;return this._httpClient.post(a,{schemaUId:t})}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(v.HttpClient))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();class Ce{copy(e){return{...e}}isEmpty(e){return!1}}class Fe extends Ce{copy(e){const t=e.metadata,a=[],s=[];return t.rules.forEach(n=>{const r=new me.H3(n,new h.CjD,null,null,null),{uId:d,name:I}=r,u=r.copy();u.name=I;const S=u.uId,y=(e.resources||[]).find(re=>re.key?.includes(d));if(y){const re=y.key.replace(d,S);s.push({...y,key:re})}a.push(u.toMetadata())}),{metadata:{...e.metadata,rules:a},name:e.name,resources:s}}isEmpty(e){return!e.metadata?.rules||e.metadata.rules?.length===0}}let Oe=(()=>{class i{create(t){return t===h.nM_.BusinessRule?new Fe:new Ce}static#e=this.\u0275fac=function(a){return new(a||i)};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})(),$=(()=>{class i{static#e=this.\u0275fac=function(a){return new(a||i)};static#t=this.\u0275mod=o.\u0275\u0275defineNgModule({type:i});static#a=this.\u0275inj=o.\u0275\u0275defineInjector({providers:[Se,Ie,Oe],imports:[T.CommonModule]})}return i})();(function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope($,{imports:[T.CommonModule]})})();var P=p(67654),fe=p(58263);class $e extends k{}class Ge{constructor(){this.caption=new h.CjD,this.description=new h.CjD}}let G=(()=>{class i extends ze{constructor(t,a){super($e),this._userInfo=t,this._resourceFinderService=a,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(t,a){return a.actions?.map(s=>({Id:s.uid,Code:s.name,Intent:{value:t},ActionType:s.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(s.caption),Description:this._resourceFinderService.findLocalizableValue(s.description),Params:s.params,PackageUId:a.package.uId}))}_convertDtoActionToSchema(t,a){const s=t.actions||[],r=a.filter(u=>s.every(S=>S.uid!==u.Id)).map(u=>{const S=new Ge;return S.uid=u.Id,S.name=u.Code,S.params=u.Params,S.actionSchemaTypeUId=u.ActionType,S.caption.setValueLocalizableString(this._sysCultureName,u.Name),S.description.setValueLocalizableString(this._sysCultureName,u.Description),S}),I=s.filter(u=>a.some(S=>S.Id===u.uid)).map(u=>{const S=a.find(y=>y.Id===u.uid);return u.name=S.Code,u.caption.setValueLocalizableString(this._sysCultureName,S.Name),u.description.setValueLocalizableString(this._sysCultureName,S.Description),u.params=S.Params,u.actionSchemaTypeUId=S.ActionType,u});t.actions=[...r,...I]}createSchema(t){const a=super.createSchema(t);return a.caption=new h.CjD(t.caption),a.description=new h.CjD(t.description),a.actions=t.actions?.map(s=>(s.description=new h.CjD(s.description),s.caption=new h.CjD(s.caption),s)),a}convertToSchema(t){return this.createSchema(t)}mapModelToSchema(t,a){return t.prompt=a.Prompt,t.description.setValueLocalizableString(this._sysCultureName,a.Description),t.caption.setValueLocalizableString(this._sysCultureName,a.Title),t.name=a.Code,t.status=a.Status,this._convertDtoActionToSchema(t,a.Actions),t}schemaToModel(t,a){return{UId:t,Title:this._resourceFinderService.findLocalizableValue(a.caption),Code:a.name,Description:this._resourceFinderService.findLocalizableValue(a.description),Prompt:a.prompt,Status:a.status,Actions:this._convertSchemaActionToDto(t,a),ExtendParent:a.extendParent,PackageUId:a.package.uId}}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(h.aoG),o.\u0275\u0275inject(h.xYn))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})(),B=(()=>{class i extends He{constructor(t){super(t)}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(o.Injector))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})(),Be=(()=>{class i extends fe.uR{constructor(){super(),this._apiService=(0,o.inject)(B),this._convertor=(0,o.inject)(G),this._currentPackageService=(0,o.inject)(ke),this._serverClientOperationNotificationReceiver=(0,o.inject)(fe.cr),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(t=>this.deleteFromCache(t.intentUId))}_normalizeUId(t){return t.toLocaleLowerCase()}_getIntentSchema(t){return this._apiService.getSchema({schemaUId:t,useFullHierarchy:!0}).pipe((0,c.map)(a=>{if(!a.success)throw new Error(a.errorInfo?.message||`Failed to get schema with UId: ${t}`);return a.schema}),(0,c.shareReplay)({bufferSize:1,refCount:!1}),(0,c.catchError)(a=>(0,c.throwError)(()=>a)))}setToCache(t,a){super.setToCache(this._normalizeUId(t),a)}getFromCache(t){return super.getFromCache(this._normalizeUId(t))}deleteFromCache(t){return super.deleteFromCache(this._normalizeUId(t))}get(t){let a=this.getFromCache(t);return a||(a=this._getIntentSchema(t),this.setToCache(t,a)),a.pipe((0,c.map)(s=>this._convertor.schemaToModel(t,s)))}update(t){return this.getFromCache(t.UId).pipe((0,c.map)(a=>this._convertor.mapModelToSchema(a,t)),(0,c.switchMap)(a=>this._apiService.saveSchema(a)),(0,c.tap)(a=>{a.success||this.deleteFromCache(t.UId)}))}create(t){return this._currentPackageService.getDesignPackageUId(null).pipe((0,c.switchMap)(a=>this._apiService.createSchema({packageUId:a.uId,extendParent:!1,schemaUId:t})),(0,c.map)(a=>a.schema),(0,c.tap)(a=>this.setToCache(t,(0,c.of)(a))),(0,c.map)(a=>this._convertor.schemaToModel(t,a)))}static#e=this.\u0275fac=function(a){return new(a||i)};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}return i})(),U=class oe{static#e=this.\u0275fac=function(t){return new(t||oe)};static#t=this.\u0275mod=o.\u0275\u0275defineNgModule({type:oe});static#a=this.\u0275inj=o.\u0275\u0275defineInjector({providers:[{provide:P.hc,useClass:Be},{provide:B,useFactory:e=>{const t=o.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:e,providers:[we("CopilotIntentSchemaDesignerService.svc"),{provide:ue,useClass:G,deps:[h.aoG]},{provide:de,useValue:!0}]});return new B(t)},deps:[o.Injector]},G],imports:[T.CommonModule,$]})};U=(0,m.gn)([(0,l.CrtModule)({})],U),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(U,{imports:[T.CommonModule,$]})}();var g=p(8239);let Z=class{constructor(e){this._intentSchemaManager=e}convert(e,t,a){var s=this;return(0,g.Z)(function*(){const n=e.map(function(){var d=(0,g.Z)(function*(I){return yield I[a]});return function(I){return d.apply(this,arguments)}}()),r=yield Promise.all(n);return(0,c.lastValueFrom)(s._intentSchemaManager.generateActionCode(r))})()}};Z=(0,m.gn)([(0,l.CrtConverter)({type:"crt.GenerateCopilotActionCode"}),(0,m.w6)("design:paramtypes",[P.Em])],Z);var Ze=p(89437),ye=p(13932),M=p(33569);let ve=class extends l.BaseRequest{};ve=(0,m.gn)([(0,l.CrtRequest)({type:"crt.CopilotSayRequest"})],ve);var _=(()=>(function(i){i.Assistant="assistant",i.User="user"}(_||(_={})),_))();let Me=class extends l.BaseRequest{};Me=(0,m.gn)([(0,l.CrtRequest)({type:"crt.CopilotRestartSessionRequest"})],Me);class _e{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgaWQ9Ikljb24gfCBBSSBDb3BpbG90IC0gMTZ4MTYgfCBoZWF2eSI+CjxwYXRoIGlkPSJTdWJ0cmFjdCIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0wLjIzNTc2MSA2LjA2NDM0QzAuMDgxNzQxOSA2LjY4NDE2IDAgNy4zMzI1MyAwIDhDMCAxMi40MTgzIDMuNTgxNzIgMTYgOCAxNkMxMC45NjExIDE2IDEzLjU0NjUgMTQuMzkxMiAxNC45Mjk3IDEySDEyLjczNjFDMTEuNTk5IDEzLjM0NSA5Ljg5OTIxIDE0LjE5OTEgOCAxNC4xOTkxQzQuNTc2MzMgMTQuMTk5MSAxLjgwMDg5IDExLjQyMzcgMS44MDA4OSA4QzEuODAwODkgNy42NTM3OSAxLjgyOTI3IDcuMzE0MjEgMS44ODM4MyA2Ljk4MzQ2TDAuMjM1NzYxIDYuMDY0MzRaTTEyLjczNjEgNC4wMDAwMUMxMS41OTkgMi42NTQ5OCA5Ljg5OTIzIDEuODAwODkgOCAxLjgwMDg5QzcuMzM1NjUgMS44MDA4OSA2LjY5NTcxIDEuOTA1NCA2LjA5NTcyIDIuMDk4ODdMMy41Mjg0NyAxLjM2NTM3QzQuODA1MDEgMC41MDMzMjcgNi4zNDM3MyAwIDggMEMxMC45NjExIDAgMTMuNTQ2NSAxLjYwODggMTQuOTI5OCA0LjAwMDAxSDEyLjczNjFaIiBmaWxsPSIjNEY0M0MyIi8+CjxwYXRoIGlkPSJzaGFwZSIgZD0iTTE2IDhMNyAxMS41TDguNSA4TDAgMkwxNiA4WiIgZmlsbD0iIzRGNDNDMiIvPgo8L2c+Cjwvc3ZnPgo="}static get title(){return"Copilot"}static get contact(){return{photo:this.photo,name:this.title}}}class N{static _getAuthorByRole(e,t){return e===_.Assistant?_e.contact:N._getUserAuthor(t)}static _getIsBotMessage(e){return e===_.Assistant}static _getMessageDirection(e){return e===_.User?ye.MessageDirection.Outcoming:ye.MessageDirection.Incoming}static _getUserAuthor(e){return{id:e.id,name:e.name,photoId:e.photoId}}static convertMessages(e,t){return e.filter(a=>(a.role===_.Assistant||a.role===_.User)&&!(0,M.Z)(a.content)).map(a=>{const s=a.createdOnTicks*1e-4,n={text:a.content,type:Ze.gKB.Text,date:new Date(s),isBotMessage:!0,id:a.id};return n.author=N._getAuthorByRole(a.role,t),n.isBotMessage=N._getIsBotMessage(a.role),n.direction=N._getMessageDirection(a.role),n})}}let Ae=class extends l.BaseRequest{};Ae=(0,m.gn)([(0,l.CrtRequest)({type:"crt.GenerateCopilotActionCodeValueRequest"})],Ae);let q=class extends l.BaseRequestHandler{constructor(e){super(),this.injector=e,this._cacheAttributeName="_ActionCodes_Cache",this._initialCodeValueAttributeName="_InitialCodeValue",this._intentManager=this.injector.get(P.Em)}_getActionCodes(e,t){var a=this;return(0,g.Z)(function*(){const s=yield e[a._cacheAttributeName];if(s?.length>0)return(0,c.of)(s);const n=yield e[t];return a._intentManager.getIntent(n?.value).pipe((0,c.map)(r=>r.Actions.map(d=>d.Code)),(0,c.tap)(r=>e[a._cacheAttributeName]=r))})()}handle(e){var t=this;return(0,g.Z)(function*(){const a=e.$context;if(a.PrimaryModelMode!==h.JIG.Create){yield t.next?.handle(e);return}let s=yield a[t._initialCodeValueAttributeName];s||(s=yield a[e.codeAttributeName],a[t._initialCodeValueAttributeName]=s);const n=yield a[e.valueAttributeName];if(!n){a[e.codeAttributeName]=s;return}const r=(yield t._getActionCodes(a,e.intentAttributeName)).pipe((0,c.switchMap)(d=>t._intentManager.generateActionCode(d,n)));a[e.codeAttributeName]=(yield(0,c.lastValueFrom)(r))??(yield a[t._initialCodeValueAttributeName]),yield t.next?.handle(e)})()}};q=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,m.w6)("design:paramtypes",[o.Injector])],q);var Y=p(33177);const f={process:"ProcessSchemaUId",params:"PDS_Params"},Ne="CopilotChatInitMessagesSubscription";let W=class extends l.BaseRequestHandler{constructor(e){super(),this._customEventService=e}handle(e){var t=this;return(0,g.Z)(function*(){const a=e.$context;a[f.process]=null;const s=yield t.next?.handle(e),n=yield a.ProcessDesignerInstanceId;return yield new Promise(r=>{const d={designerInstanceId:n,callback:r};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(d)}),s})()}};W=(0,m.gn)([(0,l.CrtRequestHandler)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,m.w6)("design:paramtypes",[Y.CustomEventService])],W);var qe=p(56707);let J=class extends l.BaseRequestHandler{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var a=this;return(0,g.Z)(function*(){const s=yield e.ProcessDesignerInstanceId;return new Promise(n=>{const r={designerInstanceId:s,needSaveNewVersion:t,saveCallback:n};a._customEventService.createOutboundChannel("saveProcessSchema").next(r)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,g.Z)(function*(){const a="Dialog.ProcessSchemaSavedWithValidationError",s=yield(0,c.lastValueFrom)(t._translateService.get(a)),n={type:"crt.NotificationRequest",$context:e,message:s,translate:!1};yield t.handlerChain.process(n)})()}handle(e){var t=this;return(0,g.Z)(function*(){const a=e.$context,s=e.config,n=s?s.needSaveNewVersion:!1;if(!(yield a.isValid()))return yield t.next?.handle(e);const d=yield t._performDesignerSave(a,n);return d.isCanceled?!1:(d.isValid||(yield t._showDesignerValidationErrorNotification(a)),yield t.next?.handle(e))})()}};J=(0,m.gn)([(0,l.CrtRequestHandler)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,m.w6)("design:paramtypes",[Y.CustomEventService,qe.sK])],J);function Pe(i){return Q.apply(this,arguments)}function Q(){return Q=(0,g.Z)(function*(i){const e="ProcessDesignerInstanceId";let t=yield i[e];t||(t=(0,l.generateGuid)(),i[e]=t)}),Q.apply(this,arguments)}let K=class extends l.BaseRequestHandler{_subscribeParamsLoaded(e){const t=new c.Subscription;t.add(e.events$.pipe((0,c.filter)(({type:a})=>a==="finish-load-model-attributes"),(0,c.filter)(({payload:a})=>a[f.params]),(0,c.switchMap)(()=>e[f.params]),(0,c.filter)(a=>!!a)).subscribe({next:function(){var a=(0,g.Z)(function*(s){let n;try{n=JSON.parse(s).processSchemaUId}catch(I){console.error(`params = ${s}
${I?.message}`)}const r={silent:!0},d={[f.process]:n};e.setValue(d,r),yield Pe(e)});return function(n){return a.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,g.Z)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};K=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotProcessActions_FormPage"]})],K);var be=p(26474);let X=class extends l.BaseRequestHandler{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",be.Ks7,f.process]}_handleProcessChange(e){if(e.attributeName===f.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[f.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,g.Z)(function*(){e.attributeName===be.TP0&&e.value===h.JIG.Create&&(e.$context[f.process]=l.EMPTY_GUID,yield Pe(e.$context))})()}handle(e){var t=this;return(0,g.Z)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const a=yield e.$context.getPrimaryModelName();e.$context.getModelByName(a).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const a=yield e.$context[f.process],s=yield e.$context.ProcessSchemaIsLoaded,n=yield e.$context.ProcessSchemaIsChanged,r=yield e.$context.HasUnsavedData,d=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=s&&a!==l.EMPTY_GUID&&(r||d||n)}return t.next?.handle(e)})()}};X=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotProcessActions_FormPage"]})],X);var Ee=p(47592);const Ye="CopilotMsgChannelSender",We="CopilotChatPart";let D=(()=>{class i{constructor(t,a,s,n){this._httpClient=t,this._messageChannelService=a,this._contextSchemaService=s,this._featureValues=n,this._apiUrl="/rest/CopilotService",this._copilotSession=null;const r=this._featureValues??{};this._isNeedToAddConsoleLog=Boolean(r.ShowSystemMessagesFromCopilot)}getInitialMessages$(){return this._loadInitialMessages()}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,c.filter)(t=>t.header.sender===Ye&&t.header.bodyTypeName===We),(0,c.map)(t=>t.body.messages),(0,c.tap)(t=>{this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(t),console.groupEnd())}))}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,c.mergeMap)(t=>this._handleActiveCopilotSessions(t).pipe((0,z.K)(a=>(console.error(a),(0,c.of)([]))))))}_handleActiveCopilotSessions(t){return t.length>0?(this._copilotSession=t[0],this._getCopilotSessionMessages(this._copilotSession.id)):(0,c.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,c.map)(t=>t.copilotSessions))}_getCopilotSessionMessages(t){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:t}).pipe((0,c.map)(a=>a.copilotMessages))}_sendUserMessage(t){return(0,c.from)(this._contextSchemaService.getContext()).pipe((0,c.switchMap)(a=>this._httpClient.post(`${this._apiUrl}/SendUserMessage`,{content:t,copilotContext:{parts:a||[]},copilotSessionId:this._copilotSession?.id})),(0,c.map)(a=>a?.copilotChatPart))}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,z.K)(t=>(0,c.throwError)(()=>new Error(`Server return status: ${t.status}`))))}sayWithResponse(t){var a=this;return(0,g.Z)(function*(){const s=yield(0,c.firstValueFrom)(a._sendUserMessage(t));return s&&(0,M.Z)(s.errorCode)&&(0,M.Z)(s.errorMessage)&&(a._copilotSession=s.copilotSession),s})()}closeSession(){var t=this;return(0,g.Z)(function*(){if(!t._copilotSession?.id)return Promise.reject("No active session");try{yield(0,c.firstValueFrom)(t._closeCopilotSession()),t._copilotSession=null}catch(a){return Promise.reject(`Server return status: ${a.status}`)}})()}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(v.HttpClient),o.\u0275\u0275inject(h.zgS),o.\u0275\u0275inject(Ee.cW),o.\u0275\u0275inject(h.Sfm,8))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),ee=class extends l.BaseRequestHandler{constructor(e,t){super(),this._copilotChatService=e,this._userInfo=t}_getConvertedMessages(e){return N.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}handle(e){var t=this;return(0,g.Z)(function*(){yield t.next?.handle(e);const a=e.$context;e.$context.ChatMessages=t._getConvertedMessages(yield(0,c.lastValueFrom)(t._copilotChatService.getInitialMessages$())),a[Ne]=t._copilotChatService.copilotMessageEvent$().subscribe(s=>{e.$context.ChatMessages=t._getConvertedMessages(s)}),e.$context.CopilotContact=_e.contact})()}};ee=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,m.w6)("design:paramtypes",[D,h.aoG])],ee);let xe=class extends l.BaseRequestHandler{constructor(){super()}handle(e){var t=this;return(0,g.Z)(function*(){const a=e.$context;for(const s of[Ne])(yield a[s])?.unsubscribe();yield t.next?.handle(e)})()}};xe=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotChatDestroyHandler",requestType:"crt.HandleViewModelDestroyRequest",scopes:["CopilotPanel"]}),(0,m.w6)("design:paramtypes",[])],xe);var Je=p(6861);class b{static#e=this.errorCodeGroups={ServiceUnavailable:["MissingApiKey","InvalidRequest","RateLimitReached","InsufficientQuota","QuotaExceeded","ModelNotFound","ModelError","InvalidResponse","UnauthorizedClient","UnsupportedGrantType","InvalidScope","InvalidJson","InvalidApiKey","Unknown","UnknownError","IncorrectConfiguration","NoEntities","Unauthorized","InvalidUri"],TryAgainLater:["ServerError","RequestTimeout","NetworkError","EngineOverloaded","InternalQuotaExceeded","ServerNotAvailable","LimitExceeded","ActionExecutionFailed"]};static#t=this.errorCodeToGroup=b._populateErrorCodeToGroupMap();static getErrorMessageKey(e){return`MessageEditor.ErrorCode.${b.errorCodeToGroup[e]||"TryAgainLater"}`}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(b.errorCodeGroups).forEach(t=>{for(const a of b.errorCodeGroups[t])e[a]=t}),e}}let Ue=(()=>{class i extends D{constructor(t,a,s,n,r,d){super(t,a,s,n),this._copilotChatService=r,this._notifyService=d}_onError(t){var a=this;return(0,g.Z)(function*(){const s=b.getErrorMessageKey(t);yield a._notifyService.error({message:s})})()}_handleError(t){var a=this;return(0,g.Z)(function*(){return(0,M.Z)(t.errorCode)?!1:(yield a._onError(t.errorCode),!0)})()}sayWithResponse(t){var a=this;return(0,g.Z)(function*(){try{const s=yield a._copilotChatService.sayWithResponse(t);if(!(yield a._handleError(s)))return s}catch{yield a._onError()}})()}static#e=this.\u0275fac=function(a){return new(a||i)(o.\u0275\u0275inject(v.HttpClient),o.\u0275\u0275inject(h.zgS),o.\u0275\u0275inject(Ee.cW),o.\u0275\u0275inject(h.Sfm,8),o.\u0275\u0275inject(D),o.\u0275\u0275inject(Je.c))};static#t=this.\u0275prov=o.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),te=class extends l.BaseRequestHandler{constructor(e){super(),this._userInfo=e.get(h.aoG),this._copilotChatService=e.get(Ue)}_getConvertedMessages(e){return N.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,a){e.$context[a]=this._getConvertedMessages(t)}_setTypingVisible(e){this._context.IsTyping=e}handle(e){var t=this;return(0,g.Z)(function*(){t._context=e.$context;const a=e.attributesMapping,s=a?.chatInput;if(!(0,M.Z)(s)){const n=yield e.$context[s];e.$context[s]="",t._setTypingVisible(!0);const r=yield t._copilotChatService.sayWithResponse(n);if(t._setTypingVisible(!1),!r)e.$context[s]=n;else if(r?.messages.length){const d=a?.chatMessages;(0,M.Z)(d)||t._addMessageToConversation(e,r.messages,d)}}yield t.next?.handle(e)})()}};te=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,m.w6)("design:paramtypes",[o.Injector])],te);var Qe=p(45087);let ae=class extends l.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(D)}handle(e){var t=this;return(0,g.Z)(function*(){yield t._copilotChatService.closeSession();const a=e.chatMessagesAttributeName,s=e.conversationEventAttributeName;!(0,M.Z)(a)&&!(0,M.Z)(s)&&(e.$context[a]=[],e.$context[s]=[{name:Qe.CONVERSATION_RESET_EVENT}]),yield t.next?.handle(e)})()}};ae=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,m.w6)("design:paramtypes",[o.Injector])],ae);let se=class extends l.BaseRequestHandler{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(P.Em)}_getModelInitConfig(e){return(0,g.Z)(function*(){const t=e.modelInitConfigs,a=yield e.getPrimaryModelName();return t?.find(s=>s.name===a)})()}_getIntent(e,t){var a=this;return(0,g.Z)(function*(){let s;const r=(yield e.getPrimaryDataSchema())?.name;return r==="CopilotIntent"?s=yield(0,c.firstValueFrom)(a._intentManager.getIntent(t)):r==="CopilotAction"&&(s=yield(0,c.firstValueFrom)(a._intentManager.getIntentByActionUId(t))),s})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,g.Z)(function*(){yield t.next?.handle(e);const a=e.$context,s=yield t._getModelInitConfig(a);if(!(s?.action===l.ModelInPageAction.Edit))return;(yield t._getIntent(a,s?.recordId))?.ExtendParent&&t._disableCodeField(a)})()}};se=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotIntents_FormPage","CopilotProcessActions_FormPage"]}),(0,m.w6)("design:paramtypes",[o.Injector])],se);let ie=class extends l.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(Ue)}handle(e){var t=this;return(0,g.Z)(function*(){const a=t._copilotChatService.sayWithResponse(e.prompt),s=t.handlerChain.process({type:"crt.OpenSidebarRequest",sidebarCode:"Copilot",$context:{}});yield Promise.all([a,s]),yield t.next?.handle(e)})()}};ie=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,m.w6)("design:paramtypes",[o.Injector])],ie);var Ke=p(25781);let ne=class extends l.BaseRequestHandler{constructor(e){super(),this._broadcastChannelFactory=e,this._init()}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(Ke.Kp)}handle(e){var t=this;return(0,g.Z)(function*(){const a=yield t.next?.handle(e);return t._workspaceReloadBroadcastService.publish(),a})()}};ne=(0,m.gn)([(0,l.CrtRequestHandler)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["CopilotIntents_FormPage"]}),(0,m.w6)("design:paramtypes",[Y.BroadcastChannelFactory])],ne);let H=class ce{static#e=this.\u0275fac=function(t){return new(t||ce)};static#t=this.\u0275mod=o.\u0275\u0275defineNgModule({type:ce});static#a=this.\u0275inj=o.\u0275\u0275defineInjector({imports:[P.q6,U]})};H=(0,m.gn)([(0,l.CrtModule)({viewElements:[],requestHandlers:[ie,ee,ne,te,se,W,X,K,J,ae,q],converters:[Z]})],H),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(H,{imports:[P.q6,U]})}()}}]);
