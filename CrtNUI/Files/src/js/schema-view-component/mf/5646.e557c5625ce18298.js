(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[5646],{5646:(E,D,u)=>{u.r(D),u.d(D,{ComboboxActionCodeEnum:()=>f,ComboboxDropdownPageSizeService:()=>A,ComboboxPreprocessorService:()=>b,ComboboxUtilsModule:()=>S,defaultAddRecordActionConfig:()=>F,defaultGoToRecordListActionConfig:()=>V});var L=u(31134),s=u(8239),C=u(96578),y=u(75378),x=u(77207),N=u(33177),d=u(49475),p=u(52045),R=u(24709),M=u(97600),h=u(21322),f;(function(P){P.AddRecord="addRecord",P.GoToRecordList="goToRecordList",P.OpenLookupPage="openLookupPage"})(f||(f={}));const F={code:f.AddRecord,type:"crt.ComboboxSearchTextAction",icon:"combobox-add-new",caption:"ComboBox.AddNewRecord",clicked:{request:"crt.CreateRecordFromLookupRequest",params:{}}},V={code:f.GoToRecordList,type:"crt.ComboboxAction",icon:"combobox-go-to-source",caption:"ComboBox.IsGoToSourceAllowedTooltip",clicked:{request:"crt.OpenLookupSourceRequest",params:{}}};var m=u(94450);class A{constructor(t){this._sysSettingsService=t,this._dropdownPageSizeFeatureName="DropdownPageSize",this._defaultDropdownPageSize=50,this._dropdownMinimumPageSize=10}_getSystemPageSize(){return(0,h.lastValueFrom)(this._sysSettingsService.getByCode(this._dropdownPageSizeFeatureName).pipe((0,h.map)(t=>this._parseSystemPagingSize(t.value)),(0,h.catchError)(()=>(0,h.of)(this._defaultDropdownPageSize))))}_getValidPageSize(t){return t>=this._dropdownMinimumPageSize?t:this._dropdownMinimumPageSize}_parseSystemPagingSize(t){const e=parseInt(t);return e||this._defaultDropdownPageSize}getPageSize(){var t=this;return(0,s.Z)(function*(){const e=yield t._getSystemPageSize();return t._getValidPageSize(e)})()}static#t=this.\u0275fac=function(e){return new(e||A)(m.\u0275\u0275inject(d.BaseSysSettingsService))};static#e=this.\u0275prov=m.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}class b{constructor(t,e,o,i,r,n){this._comboboxDropdownPageSizeService=t,this._translateService=e,this._dataSchemaRepository=o,this._rightsService=i,this._featureValues=r,this._window=n,this._disableLookupSelectionWindowFeatureName="DisableLookupSelectionWindow"}_getBindedAttributeName(t){return t.slice(1).split(".").pop()||""}_setComboboxInputs(t){this._setComboboxShowSecondaryDisplayValueState(t)}_setComboboxShowSecondaryDisplayValueState(t){t.showSecondaryDisplayValue=!!t.secondaryDisplayValue}_setComboboxShowListEvent(t,e){t.showList||(t.showList=this._createLoadDataRequestConfig(e,this._getAdditionalFilteredColumnPaths(t)),t.showList.params={...t.showList.params,config:{loadType:y.DataSourceLoadType.Reload}})}_setComboboxPaginationChange(t,e){t.paginationChange||(t.paginationChange=this._createLoadDataRequestConfig(e,this._getAdditionalFilteredColumnPaths(t)))}_createLoadDataRequestConfig(t,e){return{request:"crt.ComboboxLoadDataRequest",params:{dataSourceName:`${t}_DS`,parameters:[],primaryDisplayFilterValue:"@event.filterValue",additionalFilteredColumnPaths:e},useRelativeContext:!0}}_getAdditionalFilteredColumnPaths(t){const e=[];return t.showSecondaryDisplayValue&&e.push(t.secondaryDisplayValue),e}_setComboboxListActions(t,e){if(!t.listActions&&(t.listActions=[],t.isAddAllowed)){const i={...F,name:N.NameGenerator.generateUnique("ListAction")};t.listActions.push(i)}const o=this._findAddRecordListAction(t);if(o){const i=t.attributeName;o.clicked.params={itemsAttributeName:`${e}`,attributeName:`${i}`,detail:"@event.detail"}}}_findAddRecordListAction(t){return t?.listActions?.find(e=>e.code===f.AddRecord)}_setComboboxControlActions(t,e){if(!t.controlActions&&(t.controlActions=[],t.isGoToSourceAllowed)){const r={...V,name:N.NameGenerator.generateUnique("ControlAction")};t.controlActions.push(r)}const o=t.controlActions.find(r=>r.code===f.GoToRecordList);o&&(o.clicked.params={itemsAttributeName:`${e}`});const i=t.controlActions.find(r=>r.code===f.OpenLookupPage);i&&(i.clicked.params={itemsAttributeName:`${e}`,itemAttributeName:`${t.attributeName}`})}_getReferenceSchemaName(t,e){const o=e[`${t.attributeName}_List`];return this._getEmbeddedEntitySchemaNameFromAttributeConfig(o)}_setComboboxLinkViewConfig(t,e){const o=t.items.slice(1),i=this._getReferenceSchemaName(t,e),r=this._translateService.instant("ComboBox.EmptyDisplayValue"),n=t.attributeName;t.linkViewConfig={type:"crt.Link",mode:"preventDefault",caption:`$${n} | crt.ToObjectProp : 'displayValue' : '${r}'`,href:`$${n} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${o}'`,clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:n,recordId:`$${n} | crt.ToObjectProp : 'value'`,entityName:i}}}}_setComboboxConfig(t,e){this._setComboboxInputs(t),this._setComboboxShowListEvent(t,e),this._setComboboxListActions(t,e),this._setComboboxControlActions(t,e),this._setComboboxPaginationChange(t,e)}_checkEditPagesAndExtendWithLinkViewConfig(t,e,o){var i=this;return(0,s.Z)(function*(){yield Promise.all(t.filter(r=>r.showValueAsLink).map(function(){var r=(0,s.Z)(function*(n){(yield i._hasEditPage(n,e,o))&&i._setComboboxLinkViewConfig(n,e)});return function(n){return r.apply(this,arguments)}}()))})()}_addListAttribute(t,e){const o=t[e];t[e]={isCollection:!0,isLookup:!0,...o}}_addBusinessRuleListFilterAttribute(t,e){const o=(0,d.getBusinessRuleFilterAttributeName)(e);t[o]||(t[o]={value:{}})}_setEmbeddedModel(t,e){var o=this;return(0,s.Z)(function*(){const{vmListAttribute:i,model:r,comboboxAttributeName:n,vmAttribute:a}=t,g=(yield o._getModelSchema(r))?.attributes?.find(({name:_})=>_===e)?.referenceSchemaName;!g||(i.embeddedModel=o._createEmbeddedModel((0,d.getItemsAttributeName)(n),g,a.modelConfig?.showDeactivatedRecords))})()}_setViewModelConfig(t,e){var o=this;return(0,s.Z)(function*(){const{vmListAttribute:i,model:r,comboboxAttributeName:n}=t,c=(yield o._getModelSchema(r))?.findAttributeByName(e);if(!c){o._setEmptyViewModelConfig(t);return}const l=yield o._getDataSchema(c?.referenceSchemaName),g=o._createViewModelConfig((0,d.getItemsAttributeName)(n),l);o._setPrimaryColorConfigForViewModelConfigIfNeed(g,l,n),o._setSecondDisplayValueColumnPathConfigForViewModelConfigIfNeed(g,t,n),i.viewModelConfig=g})()}_setEmptyViewModelConfig(t){const{vmListAttribute:e,secondDisplayValueColumnPath:o}=t,i={};o&&(i.secondaryDisplayValue={}),e.viewModelConfig={attributes:{value:{},displayValue:{},primaryColorValue:{},...i}}}_setPrimaryColorConfigForViewModelConfigIfNeed(t,e,o){!e?.primaryColorAttributeName||(t.attributes.primaryColorValue={modelConfig:{path:`${(0,d.getItemsAttributeName)(o)}_DS.${e?.primaryColorAttributeName}`}})}_setSecondDisplayValueColumnPathConfigForViewModelConfigIfNeed(t,e,o){!e.secondDisplayValueColumnPath||(t.attributes.secondaryDisplayValue={modelConfig:{path:`${(0,d.getItemsAttributeName)(o)}_DS.${e.secondDisplayValueColumnPath}`}})}_getFilterAttributes(t,e){const o=t.modelConfig,i={name:(0,d.getBusinessRuleFilterAttributeName)((0,d.getItemsAttributeName)(e)),loadOnChange:!0},r=o?.filterAttributes??[];return r.find(n=>n.name===i.name)||r.push(i),r}_setModelConfig(t,e){var o=this;return(0,s.Z)(function*(){const{vmListAttribute:i,model:r,comboboxAttributeName:n}=t,a=yield o._getModelConfigDefaultSorting(r,e),c=yield o._comboboxDropdownPageSizeService.getPageSize(),l=o._getFilterAttributes(i,n),g=o._createModelConfig((0,d.getItemsAttributeName)(n),a,c,l);o._mergeModelConfig(i,g)})()}_getModelConfigDefaultSorting(t,e){var o=this;return(0,s.Z)(function*(){const i=[],n=(yield o._getModelSchema(t))?.findAttributeByName(e);if(n){const a=yield o._getDataSchema(n.referenceSchemaName);i.push(o._getDefaultSorting(a))}return i})()}_getDefaultSorting(t){return{columnName:t?.primaryDisplayAttributeName,direction:"asc"}}_getDataSchema(t){var e=this;return(0,s.Z)(function*(){let o;try{o=yield(0,h.lastValueFrom)(e._dataSchemaRepository.get(t),{defaultValue:null})}catch{o=null}return Promise.resolve(o)})()}_mergeModelConfig(t,e){const o=t.modelConfig;t.modelConfig=(0,M.merge)(e,o)}_getComboboxLookupModeFromDataSchema({attribute:t,models:e}){var o=this;return(0,s.Z)(function*(){const i=o._getDataSourceNameFromAttributeConfig(t),r=o._getTargetFieldNameFromAttributeConfig(t),n=o._getModelByDataSourceName(i,e),c=(yield o._getModelSchema(n))?.findAttributeByName(r),l=C.LookupMode.List;return c?.lookupMode??l})()}_setComboboxMode({viewConfig:t,attributes:e,models:o,comboboxAttributeName:i}){var r=this;return(0,s.Z)(function*(){const n=!r._featureValues[r._disableLookupSelectionWindowFeatureName];if(!(0,M.get)(r._window,"Terrasoft")?.isAngularHost||!n){t.mode=C.LookupMode.List;return}const c=e[i]??{};!(0,R.isModelAttributeConfig)(c)||(t.mode===void 0&&(t.mode=yield r._getComboboxLookupModeFromDataSchema({attribute:c,models:o})),t.mode===C.LookupMode.SelectionWindow&&r._setSelectionWindowAction(t,e))})()}_setComboboxListAttribute({attributes:t,models:e,comboboxAttributeName:o},i){var r=this;return(0,s.Z)(function*(){const n=t[o]??{};if(!(0,R.isModelAttributeConfig)(n))return;const a=r._getDataSourceNameFromAttributeConfig(n),c=r._getTargetFieldNameFromAttributeConfig(n),l=t[(0,d.getItemsAttributeName)(o)],g=r._getModelByDataSourceName(a,e),_={vmListAttribute:l,model:g,comboboxAttributeName:o,vmAttribute:n,secondDisplayValueColumnPath:i};yield r._setEmbeddedModel(_,c),yield r._setViewModelConfig(_,c),yield r._setModelConfig(_,c)})()}_setComboboxListSortingAttribute(t,e){const o=this._getComboboxListSortingAttributeName(e),i=t[o];t[o]={...i,isCollection:!0,viewModelConfig:{attributes:{columnName:{},direction:{}}}}}_getComboboxListSortingAttributeName(t){return`${t}_Sorting`}_hasEditPage(t,e,o){var i=this;return(0,s.Z)(function*(){const r=i._getReferenceSchemaName(t,e);if(!r)return Promise.resolve(!1);const n={type:"crt.7XRequest",action:"HasEntityEditPage",$context:o,payload:{entityName:r}};return yield y.HandlerChainService.instance.process(n)})()}_createAttributeConfigByDataSchema(t,e){var o=this;return(0,s.Z)(function*(){const i=[o._getDefaultSorting(e)],r=yield o._comboboxDropdownPageSizeService.getPageSize();return{isCollection:!0,isLookup:!0,embeddedModel:o._createEmbeddedModel(t,e.name),viewModelConfig:o._createViewModelConfig(t,e),modelConfig:o._createModelConfig(t,i,r,[])}})()}_createAndAddFilterAttribute(t){const e=t.filterAttributeName||`${t.listAttributeName}_Filter`,r=((t.attributes[t.listAttributeName]||{}).modelConfig||{}).filterAttributes||[];!!r.find(a=>a.name===e)||r.push({name:e,loadOnChange:!0}),t.attributes[e]={value:t.filter}}_createEmbeddedModel(t,e,o=!1){return{name:`${t}_DS`,config:{type:"crt.EntityDataSource",config:{entitySchemaName:e,useRecordDeactivation:!o}}}}_createViewModelConfig(t,e){return{attributes:{value:{modelConfig:{path:`${t}_DS.${e?.primaryAttributeName}`}},displayValue:{modelConfig:{path:`${t}_DS.${e?.primaryDisplayAttributeName}`,ignoreValidators:!this._featureValues.DisableIgnoreLookupsDisplayValueValidators}}}}}_createModelConfig(t,e,o,i){return{path:`${t}_DS`,sortingConfig:{attributeName:this._getComboboxListSortingAttributeName(t),default:e},pagingConfig:{rowCount:o,rowsOffset:null},filterAttributes:i}}_getFiltersConfig(t,e){const i=t[e]?.modelConfig?.filterAttributes;if(!i)return null;const r={};return i.forEach(n=>{r[n.name]={value:"$"+n.name}}),{filterAttributes:i,attributesConfig:r}}_setSelectionWindowAction(t,e){const o=(0,d.getItemsAttributeName)(t.control).slice(1),i=t.attributeName;if(!o||!i)return;const r=this._getFiltersConfig(e,o),n=!!this._findAddRecordListAction(t),a=e[i]??{},c=Boolean(a.modelConfig?.showDeactivatedRecords);t.selectionWindowIconPressed={request:"crt.OpenSelectionWindowRequest",params:{itemsAttributeName:o,itemAttributeName:i,filtersConfig:r,features:{showDeactivatedRecords:c,create:{enabled:n}}}}}_actualizeComboboxAddRecordAction(t,e,o){var i=this;return(0,s.Z)(function*(){if(i._featureValues.DisableCheckingForAddRecordActionInCombobox)return;const r=t.filter(l=>!!i._findAddRecordListAction(l)),n=yield i._getViewConfigsWithEditPage(r,e,o),a=i._getDifferentElementsInConfigCollections(r,n),c=yield i._getIsNotAllowedAddRecordActionViewConfigs(n,e);[...a,...c].forEach(l=>i._disableAddRecordAction(l))})()}_getDifferentElementsInConfigCollections(t,e){return t.filter(o=>!e.some(i=>o.attributeName===i.attributeName))}_getViewConfigsWithEditPage(t,e,o){var i=this;return(0,s.Z)(function*(){return(yield Promise.all(t.map(function(){var r=(0,s.Z)(function*(n){return(yield i._isViewConfigIfWithoutEditPage(n,e,o))?null:n});return function(n){return r.apply(this,arguments)}}()))).filter(r=>!!r)})()}_isViewConfigIfWithoutEditPage(t,e,o){var i=this;return(0,s.Z)(function*(){return!i._getReferenceSchemaName(t,e)||!(yield i._hasEditPage(t,e,o))})()}_getIsNotAllowedAddRecordActionViewConfigs(t,e){var o=this;return(0,s.Z)(function*(){if(!t||t.length===0)return[];const i=yield o._getIsNotAllowedAddRecordActionSchemaNames(t,e);return t.filter(r=>i.includes(o._getReferenceSchemaName(r,e)))})()}_getIsNotAllowedAddRecordActionSchemaNames(t,e){var o=this;return(0,s.Z)(function*(){const i=[...new Set(t?.map(n=>o._getReferenceSchemaName(n,e)))];return(yield(0,h.lastValueFrom)(o._rightsService.getCanAdd(i).pipe((0,h.catchError)(()=>(0,h.of)(null)))))?.filter(n=>!n.result).map(n=>n.schemaName)??[]})()}_disableAddRecordAction(t){this._removeAddRecordAction(t),this._disableAddRecordInSelectionWindow(t)}_removeAddRecordAction(t){const e=this._findAddRecordListAction(t);t.listActions=t.listActions.filter(o=>o!==e)}_disableAddRecordInSelectionWindow(t){const o=(t.selectionWindowIconPressed?.params?.features||{}).create||{};o.enabled=!1}_setActivityResultFilters(t,e,o){var i=this;return(0,s.Z)(function*(){!(yield i._isNeedAddActivityResultFilter(t,e,o))||i._addActivityResultFiltersAttributes(t,o)})()}_isNeedAddActivityResultFilter(t,e,o){var i=this;return(0,s.Z)(function*(){const r=t[o],n=i._getDataSourceNameFromAttributeConfig(r);if((0,M.isEmpty)(n))return!1;const a=i._getModelByDataSourceName(n,e);if((yield i._getModelSchema(a))?.name!=="Activity")return!1;const l=(0,d.getItemsAttributeName)(o),g=t[l];return i._getEmbeddedEntitySchemaNameFromAttributeConfig(g)==="ActivityResult"})()}_getModelSchema(t){return(0,h.lastValueFrom)(t.getSchema(),{defaultValue:null})}_getEmbeddedEntitySchemaNameFromAttributeConfig(t){return t&&"embeddedModel"in t&&t.embeddedModel?.config?.config?.entitySchemaName}_getModelByDataSourceName(t,e){return e.find(o=>o.name===t)}_addActivityResultFiltersAttributes(t,e){const o=(0,d.getItemsAttributeName)(e),i=t[e],r=this._getDataSourceNameFromAttributeConfig(i);this._createAndAddBusinessProcessOnlyFilterAttribute(t,o),this._createResultByCategoryFilterAttribute(t,o,r)}_getDataSourceNameFromAttributeConfig(t){return t.modelConfig?.path.split(".")[0]}_getTargetFieldNameFromAttributeConfig(t){return t.modelConfig?.path.split(".").pop()}_createAndAddBusinessProcessOnlyFilterAttribute(t,e){const o=this._createBusinessProcessOnlyFilter();this._createAndAddFilterAttribute({attributes:t,listAttributeName:e,filter:o,filterAttributeName:`${e}_BusinessProcessOnlyFilter`})}_createBusinessProcessOnlyFilter(){const t=new y.FilterGroup;return t.addSchemaColumnFilterWithParameter(y.ComparisonType.Equal,"BusinessProcessOnly",!1,"BusinessProcessOnlyFilter"),t}_createResultByCategoryFilterAttribute(t,e,o){const i=`${e}_CategoryFilter`;this._createAndAddFilterAttribute({attributes:t,listAttributeName:e,filter:null,filterAttributeName:i}),t[i]={from:[this._getOrCreateAttributeByModelConfigPath(`${o}.ActivityCategory`,t),this._getOrCreateAttributeByModelConfigPath(`${o}.AllowedResult`,t)],converter:"crt.ActivityResultsFilters"}}_getOrCreateAttributeByModelConfigPath(t,e){const o=this._findAttributeByModelConfigPath(t,e);return o||this._createAttributeWithModelConfigPath(t,e)}_findAttributeByModelConfigPath(t,e){return Object.keys(e).find(o=>(e[o]??{}).modelConfig?.path===t)}_createAttributeWithModelConfigPath(t,e){const o=t.replace(".","_");return e[o]={modelConfig:{path:t}},o}crtOnMetaDataInit(t,e){t=t.filter(o=>(0,p.isBindToViewModelAttribute)(o.control,e)),t.forEach(o=>{const i=o.control,r=this._getBindedAttributeName(i),n=o.items,a=(0,d.getItemsAttributeName)(r);if((0,p.isBindToViewModelAttribute)(n,e)){const c=n.slice(1).split(".").pop();e[c].isLookup=!0}else this._addListAttribute(e,a),o.items=(0,d.getItemsAttributeName)(i);this._addBusinessRuleListFilterAttribute(e,a),o.attributeName=r,this._setComboboxConfig(o,a)})}crtOnModelInit(t,e,o){var i=this;return(0,s.Z)(function*(){t=t.filter(r=>(0,p.isBindToViewModelAttribute)(r.control,e)),yield Promise.all(t.map(function(){var r=(0,s.Z)(function*(n){const a=i._getBindedAttributeName(n.control);i._setComboboxListSortingAttribute(e,(0,d.getItemsAttributeName)(a)),yield i._setComboboxListAttribute({attributes:e,models:o,comboboxAttributeName:a},n.showSecondaryDisplayValue?n.secondaryDisplayValue:""),yield i._setActivityResultFilters(e,o,a),yield i._setComboboxMode({viewConfig:n,attributes:e,models:o,comboboxAttributeName:a})});return function(n){return r.apply(this,arguments)}}()))})()}crtOnViewModelInit(t,e,o){var i=this;return(0,s.Z)(function*(){t=t.filter(r=>(0,p.isBindToViewModelAttribute)(r.items,e)),yield i._checkEditPagesAndExtendWithLinkViewConfig(t,e,o),yield i._actualizeComboboxAddRecordAction(t,e,o)})()}setupComboboxMetadataByEntitySchema(t,e,o,i){var r=this;return(0,s.Z)(function*(){const n=yield r._getDataSchema(o);if(!n)return;const a=(0,d.getItemsAttributeName)(t.name);e[a]=yield r._createAttributeConfigByDataSchema(a,n),i&&r._createAndAddFilterAttribute({attributes:e,listAttributeName:a,filter:i}),r._setComboboxListSortingAttribute(e,a),t.items=`$${a}`,r._setComboboxShowListEvent(t,a),r._setComboboxPaginationChange(t,a)})()}static#t=this.\u0275fac=function(e){return new(e||b)(m.\u0275\u0275inject(A),m.\u0275\u0275inject(x.TranslateService),m.\u0275\u0275inject(R.DataSchemaRepositoryService),m.\u0275\u0275inject(d.BaseRightsService),m.\u0275\u0275inject(d.FEATURE_VALUES),m.\u0275\u0275inject(N.WINDOW_TOKEN))};static#e=this.\u0275prov=m.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac})}class S{static#t=this.\u0275fac=function(e){return new(e||S)};static#e=this.\u0275mod=m.\u0275\u0275defineNgModule({type:S});static#o=this.\u0275inj=m.\u0275\u0275defineInjector({providers:[b,A],imports:[L.CommonModule]})}(function(){(typeof ngJitMode>"u"||ngJitMode)&&m.\u0275\u0275setNgModuleScope(S,{imports:[L.CommonModule]})})()}}]);
