(self.webpackChunkapp_studio_enterprise_duplicates_widget=self.webpackChunkapp_studio_enterprise_duplicates_widget||[]).push([[5788],{55788:(we,me,p)=>{p.r(me),p.d(me,{BaseDataGridColumnEditHandler:()=>x,BaseDataGridStateHandlerService:()=>K,BooleanCellViewElementConfigCreator:()=>X,BooleanEditingCellViewElementConfigCreator:()=>L,CAN_CREATE_DEFAULT_GRID_SETTING_OPERATION_CODE:()=>Ae,CHECK_DATA_GRID_COLUMNS_RIGHTS_ON_LOAD:()=>fe,CellViewElementConfigCreator:()=>C,CrtDataGridCdkModule:()=>oe,DATA_GRID_AVAILABLE_EDITING_DATA_VALUE_TYPES:()=>ye,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>ae,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Fe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>pe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>be,DISABLE_DATA_GRID_EDITING_MODE_FEATURE_CODE:()=>Se,DISABLE_DATA_GRID_MULTIPLE_ROWS_SELECTION_FEATURE_CODE:()=>Ie,DataGridCancelItemsChangesHandler:()=>re,DataGridCancelItemsChangesRequest:()=>le,DataGridColumnDefinitionService:()=>q,DataGridRowDoubleClickHandler:()=>ie,DataGridRowDoubleClickRequest:()=>ue,DateTimeCellViewElementConfigCreator:()=>B,DateTimeEditingCellViewElementConfigCreator:()=>G,DcmStageCellViewElementConfigCreator:()=>F,DcmStageEditingCellViewElementConfigCreator:()=>w,EditingCellViewElementConfigCreator:()=>D,EmailCellViewElementConfigCreator:()=>I,EmailEditingCellViewElementConfigCreator:()=>M,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>he,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Re,FileCellViewElementConfigCreator:()=>A,FileSizeCellViewElementConfigCreator:()=>v,LookupCellViewElementConfigCreator:()=>H,LookupEditingCellViewElementConfigCreator:()=>N,NativeLinkCellViewElementConfigCreator:()=>z,NumericCellViewElementConfigCreator:()=>k,NumericEditingCellViewElementConfigCreator:()=>R,PhoneCellViewElementConfigCreator:()=>S,PhoneEditingCellViewElementConfigCreator:()=>O,PrimaryCellViewElementConfigCreator:()=>Z,RichTextCellViewElementConfigCreator:()=>V,SchemaDataGridColumnEditHandler:()=>ee,SchemaDataGridColumnSelectionService:()=>te,StructureExplorerDataGridColumnSelectionService:()=>Q,TextCellViewElementConfigCreator:()=>j,TextEditingCellViewElementConfigCreator:()=>b,WebEditingCellViewElementConfigCreator:()=>$});var i=p(94450),_=p(34038),T=p(14537),P=p(52045),m=p(21322),g=p(27049);class K{get viewModel$(){return this.injector?this.injector.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)):(0,m.of)(null)}constructor(e){this.schemaService=e}getColumnsFromSchema(e){const t=e?.columns??[];if(typeof t=="string"){const a=t.split("$").pop();return this.viewModel$.pipe((0,g.map)(n=>(n?.attributes??{})[a]||[]))}return(0,m.of)(t)}getDataSourceName(e){const t=(0,_.getViewModelItemsAttributeName)(e);return this.viewModel$.pipe((0,g.map)(a=>a?.getBoundDataSourceNameByAttributePath(t)))}handle(e,t){this.injector=t;const a=t.get(T.VIEW_ELEMENT_CONFIG),n=this.schemaService.getViewConfigInfoByName(a.name).viewConfig,r=e.columns??[];return this.getDataSourceName(n).pipe((0,g.switchMap)(s=>s?this.getColumnsFromSchema(n).pipe((0,g.switchMap)(c=>{const d={viewElementConfig:n,dataSourceName:s,columns:r,previousColumns:c};return this.innerHandle(d)})):(0,m.of)(void 0)))}static#e=this.\u0275fac=function(t){return new(t||K)(i.\u0275\u0275inject(P.SchemaService))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac})}var u=p(8239),o=p(75378),ge=p(77207),_e=p(59929),h=p(49475),E=p(97600);class x{constructor(e){this._translateService=e.get(ge.TranslateService),this._columnEditService=e.get(_.DataGridColumnEditService),this._entitySchemaService=e.get(h.EntitySchemaService),this._entitySchemaProvider=e.get(h.EntitySchemaProvider),this.schemaService=e.get(P.SchemaService)}_replaceColumn(e,t,a){if(!e)return a;const n=(0,E.findIndex)(a,r=>r.id===t);return a[n]={...e,changed:!0},a}_getEntitySchemaName(e,t){if(!e)return null;const n=t.getBoundDataSchemaByAttributePath(e)?.dataSourceConfig;return n?.type!=="crt.EntityDataSource"?null:n.config?.entitySchemaName}getResources(e,t){return Promise.resolve(this.schemaService.resources)}processColumns(e,t,a){var n=this;return(0,u.Z)(function*(){const r=yield n.getResources(e,t),s=(0,_.getDataGridItemsAttributeName)(e),c=n._getEntitySchemaName(s,t);for(const d of a)yield n._setColumnModelProperties(d,t,c,s),n.setColumnCaptionResources(d,r,e);return{dataSourceSchemaName:c,columns:a}})()}_setColumnModelProperties(e,t,a,n){var r=this;return(0,u.Z)(function*(){if(!n||!a||!e.code)return;const s=`${n}.${e.code}`,c=t.getBoundDataSchemaAttributeByAttributePath(s);if(!c?.path||c.attributeType!==o.DataSchemaAttributeType.AggregationAttribute)return;const d=yield r.getEntitySchemaNameByPath(a,c.path);e.path=c.path,e.aggregationConfig=c.aggregationConfig||e.aggregationConfig,e.referenceSchemaName=d||e.referenceSchemaName})()}_processColumnOriginalCaption(e,t){const a=t.path,n=a?.startsWith("[")?t.referenceSchemaName:e;return!a||!n||!t.aggregationConfig?(0,m.of)(t):this._entitySchemaProvider.getSchemaByName(n).pipe((0,g.switchMap)(r=>this._entitySchemaService.getEntitySchemaColumnsInformationByPath(r.uId,a," > ")),(0,g.map)(r=>{let s=r.columnCaptionPath;const c=t.aggregationConfig?.aggregationFunction;return c&&(s=this._getAggregationColumnOriginalCaption(s,t.dataValueType,c)),t.originalCaption=s,t}))}_getAggregationColumnOriginalCaption(e,t,a){const n=(0,_e.getAllowedAggregationFunctionsByDataValueType)(t);n.push({func:o.AggregationFunction.Count,captionResource:"Count"});const r=n.find(c=>c.func===a)?.captionResource||"",s=this._getAggregationFunctionCaption(r);return a===o.AggregationFunction.TopOne?this._translateService.currentLang===h.DEFAULT_CULTURE_NAME?`${e} (the ${s.toLowerCase()})`:`${e} (${s.toLowerCase()})`:a===o.AggregationFunction.Count?`${e.split(" > ").slice(0,-1).join(" > ")} ${s}`:`${e} ${s}`}_getAggregationFunctionCaption(e){return this._translateService.instant("AggregationNames."+e)}onColumnPreparationFinished(){}handle(e,t,a){const n=a.get(T.VIEW_ELEMENT_CONFIG),r=this.schemaService.getViewConfigInfoByName(n.name).viewConfig;return a.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)).pipe((0,g.mergeMap)(d=>this.processColumns(r,d,t)),(0,g.mergeMap)(d=>{const f=(0,E.cloneDeep)(d.columns.find(y=>y.id===e));return this._processColumnOriginalCaption(d.dataSourceSchemaName,f).pipe((0,m.tap)(()=>this.onColumnPreparationFinished()),(0,g.mergeMap)(y=>this._columnEditService.edit(y,a).pipe((0,g.map)(J=>this._replaceColumn(J,e,d.columns)))))}))}static#e=this.\u0275fac=function(t){return new(t||x)(i.\u0275\u0275inject(i.Injector))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac})}var De=p(18369),se=p(33177),Te=p(96923),Ee=p(54134);const ae=new i.InjectionToken("A cell view config factory"),pe=new i.InjectionToken("A factory of editing cell view config creators"),he=new i.InjectionToken("A cell view config factory");class Q{constructor(e,t,a,n){this.structureExplorer=e,this.schemaService=t,this.cellViewConfigCreatorFactory=a,this.translateService=n}_openStructureExplorer(e){return this.structureExplorer.show({providers:[e],enableMultiSelection:!0,collectDrillDownItems:!0})}_getColumnCaptionResourceMacros(e,t){const a=t.split(".").join("");return`#ResourceString(${e}_${a})#`}_getStructureExplorerDataProviderConfig(e,t){const a=e.getBoundDataSourceNameByAttributePath(t);return{name:Te.DATA_SOURCE_STRUCTURE_EXPLORER_DATA_PROVIDER_NAME,navigateOnlyThroughDataSource:a,options:{useBackwards:!0}}}_modifyAggregationColumnCode(e,t){return e+t+Ee.Guid.create().toString().slice(0,8)}createColumnDefinition(e){const{structureExplorerItem:t,dataSourceName:a}=e,n=this.getColumnName(t.columnPath),r=t.data?.item?.aggregationFunction;let s=`${a}_${n}`;r&&(s=this._modifyAggregationColumnCode(s,r));const c=t.data.dataValueType,d=r?this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction):this._getColumnCaptionResourceMacros(a,n),f=t.data.isMasked,y={id:(0,o.generateGuid)(),code:s,path:t.columnPath,caption:d,dataValueType:c,referenceSchemaName:t.data?.item?.referenceSchemaName,isMasked:f};return r&&(y.aggregationConfig={aggregationFunction:t.data?.item?.aggregationFunction},r===o.AggregationFunction.TopOne&&(y.aggregationConfig.sortByColumn="Id",y.aggregationConfig.sortByDirection=o.OrderDirection.Asc),y.captionResources=new h.LocalizableStringArray,y.captionResources.setValueLocalizableString(this.translateService.currentLang,this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction)),y.captionResourcesChanged=!0),{...y}}getItemsAttributeName(e){const t=e.get(T.VIEW_ELEMENT_CONFIG),a=this.schemaService.getViewConfigInfoByName(t.name).viewConfig;return(0,_.getViewModelItemsAttributeName)(a)}getAggregationColumnCaption(e,t,a){return a===o.AggregationFunction.TopOne?this.translateService.currentLang===h.DEFAULT_CULTURE_NAME?`${e} (the ${t.toLowerCase()})`:`${e} (${t.toLowerCase()})`:`${e} ${t}`}getColumnName(e){return(0,h.removeSpecialSymbols)(e)}selectColumns(e){const a=e.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)),n=this.getItemsAttributeName(e);if(!n)return(0,m.of)([]);const r=a.pipe((0,g.map)(c=>c?.getBoundDataSourceNameByAttributePath(n))),s=a.pipe((0,g.map)(c=>this._getStructureExplorerDataProviderConfig(c,n)),(0,g.switchMap)(c=>this._openStructureExplorer(c)));return(0,m.forkJoin)([s,r]).pipe((0,g.map)(([c,d])=>(c??[]).filter(f=>f.id!==d).map(f=>this.createColumnDefinition({structureExplorerItem:f,dataSourceName:d}))))}static#e=this.\u0275fac=function(t){return new(t||Q)(i.\u0275\u0275inject(De.StructureExplorerService),i.\u0275\u0275inject(P.SchemaService),i.\u0275\u0275inject(ae),i.\u0275\u0275inject(ge.TranslateService))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac})}class C{constructor(){this.type=""}getDisplayValue(e){const{column:t,itemsAttributeName:a}=e??{};return`${a}.${t?.code}`}getInitialViewElementConfig(e){const{column:t}=e??{};return{column:{...t},value:this.getDisplayValue(e),type:this.type}}getViewElementConfig(e){return Promise.resolve(this.getInitialViewElementConfig(e))}}class j extends C{constructor(){super(...arguments),this.type="crt.TableTextCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(j)))(a||j)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac,providedIn:"root"})}class B extends C{constructor(){super(...arguments),this.type="crt.TableDateTimeCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(B)))(a||B)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"})}class k extends C{constructor(){super(...arguments),this.type="crt.TableNumericCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(k)))(a||k)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"})}var U=p(24709);class W extends C{constructor(){super(),this.type="crt.Link"}hasSectionEditPage(e){var t=this;return(0,u.Z)(function*(){const a=yield t.getReferenceSchemaName(e),n={type:"crt.7XRequest",action:"HasEntityEditPage",$context:e.context,payload:{entityName:a}};return yield o.HandlerChainService.instance.process(n)})()}getDefaultViewElementConfig(e){return Promise.resolve(null)}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){return(yield t.hasSectionEditPage(e))?t.getLinkViewElementConfig(e):t.getDefaultViewElementConfig(e)})()}static#e=this.\u0275fac=function(t){return new(t||W)};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac})}class Z extends W{constructor(){super()}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.primaryAttributeName??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:a,primaryAttributeName:n,column:r}=e,s=t.getDisplayValue(e);return{column:r,caption:s,type:t.type,href:`${a}.${n} | crt.ToRecordLinkAsync : '${n}'`,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:a.slice(1),recordId:`${a}.${n}`}}}})()}static#e=this.\u0275fac=function(t){return new(t||Z)};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"})}var ne=p(41307);class H extends W{constructor(e,t,a){super(),this._featureService=e,this._entitySchemaRepository=t,this._dcmSchemaManagerService=a,this._colorizedSchemasMap=new Map,this.type="crt.Link"}_isColumnColorized(e){var t=this;return(0,u.Z)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridColoredCell")),n=yield t.getReferenceSchemaName(e);if(!n||a)return Promise.resolve(!1);const r=t._colorizedSchemasMap.get(n);return r!==void 0?r:(0,m.lastValueFrom)(t._entitySchemaRepository.getSchemaByName(n).pipe((0,m.map)(s=>{const c=!!s.getPrimaryColorColumn();return t._colorizedSchemasMap.set(n,c),c}),(0,m.catchError)(()=>(0,m.of)(!1))))})()}_decorateConfigWithColorization(e,t){const a=super.getDisplayValue(t);e.type="crt.TableColoredCell",e.displayValue=a}_isStageColumn(e){var t=this;return(0,u.Z)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridProgressBarStageCell"));if(!e.dataGridSchemaName||a)return Promise.resolve(!1);const n=yield(0,m.firstValueFrom)(t._entitySchemaRepository.getSchemaByName(e.dataGridSchemaName)),r=(yield(0,m.firstValueFrom)(t._dcmSchemaManagerService.getDcmSchemaDataCollection())).find(c=>c.entitySchemaUId===n.uId&&c.isActive&&c.isActiveVersion);if(!r)return Promise.resolve(!1);const s=n.columns?.find(c=>c.uId===r.stageColumnUId)?.name;return s?e.column.code.split("_").pop()===s:Promise.resolve(!1)})()}_decorateConfigWithSlider(e,t){const a=`${t.dataGridName}_DCMData`;e.type="crt.TableSliderCell";const n=t.column?.code??"",s=`${`${t.itemsAttributeName}.${n}`} | crt.ToEntityStageDataTableSliderConverterAsync:$${a}`;e.percentage=`${s} | crt.ToObjectProp : 'value'`,e.color=`${s} | crt.ToObjectProp : 'color'`,e.value=this.getDisplayValue(t)}getDisplayValue(e){return`${super.getDisplayValue(e)} | crt.ToObjectProp : 'displayValue'`}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.column.code??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getDefaultViewElementConfig(e){var t=()=>super.getInitialViewElementConfig,a=this;return(0,u.Z)(function*(){let n=t().call(a,e);const r=yield a._isColumnColorized(e),s=yield a._isStageColumn(e),c=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return s&&!c?a._decorateConfigWithSlider(n,e):r?a._decorateConfigWithColorization(n,e):n=null,n})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:a,column:n}=e,r=t.getDisplayValue(e),s=yield t.getReferenceSchemaName(e),c=n?.code??"",d=`${a}.${c} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${c}'`,f={type:"crt.Link",column:{...n},caption:r,href:d,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{entityName:s,recordId:`${a}.${c} | crt.ToObjectProp : "value"`}}},y=yield t._isColumnColorized(e),J=yield t._isStageColumn(e),ce=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return J&&!ce?t._decorateConfigWithSlider(f,e):y&&t._decorateConfigWithColorization(f,e),f})()}static#e=this.\u0275fac=function(t){return new(t||H)(i.\u0275\u0275inject(ne.FeatureService),i.\u0275\u0275inject(h.EntitySchemaRepository),i.\u0275\u0275inject(ne.DcmSchemaManagerService))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac,providedIn:"root"})}class X extends C{constructor(e){super(),this._defaultFeatures=e,this.type="crt.TableBooleanCell"}_getEditingModeDisabledExpression(e){if((0,P.isBindingExpression)(e))return`${e} | crt.PickDataGridFeatureValue : 'editable.enable' | crt.InvertBooleanValue`;const t=(0,_.fullInDataTableEditingFeatures)(e?.editable,!0);return!(0,_.fullInDataTableEditingFeatures)(this._defaultFeatures?.editable,!1).enable||!t.enable}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const n=yield t().call(a,e),r=a.getDisplayValue(e),s=e.column.readonly===!0,c=a._getEditingModeDisabledExpression(e.features);return{...n,control:r,readonly:s||c,bindTo:r,readiness:`$${U.BUSINESS_RULES_ACTIVATED_SYSTEM_ATTRIBUTE_NAME}`}})()}static#e=this.\u0275fac=function(t){return new(t||X)(i.\u0275\u0275inject(_.DATA_GRID_FEATURES,8))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"})}class S extends C{constructor(){super(...arguments),this.type="crt.TablePhoneCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(S)))(a||S)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:S,factory:S.\u0275fac,providedIn:"root"})}class I extends C{constructor(){super(...arguments),this.type="crt.TableEmailCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(I)))(a||I)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"})}class A extends C{constructor(){super(...arguments),this.type="crt.TableFileCell"}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:a,primaryAttributeName:n,dataSchemaName:r,column:s}=e;return{column:{...s},fileName:t.getDisplayValue(e),fileUrl:`${a}.${n} | crt.ToFileLink : '${r}'`,type:t.type}})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(A)))(a||A)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}class v extends C{constructor(){super(...arguments),this.type="crt.TableFileSizeCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(v)))(a||v)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"})}class V extends C{constructor(){super(...arguments),this.type="crt.TableRichTextEditorCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(V)))(a||V)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"})}class z extends C{constructor(){super(),this.type="crt.Link"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const n=yield t().call(a,e),r=e.column.dataValueType===o.DataValueType.EMAIL_TEXT;return n.href=r?`${n.value} | crt.ToEmailLink`:`${n.value} | crt.LinkPrefix`,n.caption=`${n.value}`,n.mode="native",n.target=r?"_self":"_blank",n})()}static#e=this.\u0275fac=function(t){return new(t||z)};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:z,factory:z.\u0275fac,providedIn:"root"})}class F extends C{constructor(){super(...arguments),this.type="crt.TableDcmStageCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const n=yield t().call(a,e),r=a.getDisplayValue(e);return{...n,value:r,bindTo:r,dcmStages:"$DcmStages"}})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(F)))(a||F)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"})}class D{constructor(){this.type=""}getColumnDataSchemaAttribute(e){const{column:t,context:a,itemsAttributeName:n}=e,r=(0,_.getDataGridItemsAttributeName)({items:n});if(!t.code||!r)return null;const s=`${r}.${t.code}`;return a.getBoundDataSchemaAttributeByAttributePath(s)}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{column:a,itemsAttributeName:n}=e??{};return{type:t.type,control:`${n}.${a.code}`,bindTo:`${n}.${a.code}`}})()}}class b extends D{constructor(){super(...arguments),this.type="crt.DataTableEditTextCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(b)))(a||b)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"})}class R extends D{constructor(){super(...arguments),this.type="crt.DataTableEditNumericCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(R)))(a||R)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"})}class N extends D{constructor(){super(...arguments),this.type="crt.DataTableEditLookupCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(N)))(a||N)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac,providedIn:"root"})}class G extends D{constructor(){super(...arguments),this._dataValueTypeToDateType=new Map([[o.DataValueType.Date,h.DateTypes.Date],[o.DataValueType.Time,h.DateTypes.Time],[o.DataValueType.DateTime,h.DateTypes.DateTime]]),this.type="crt.DataTableEditDateTimeCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const{column:n}=e??{};return{...yield t().call(a,e),dateType:a._dataValueTypeToDateType.get(n.dataValueType)??h.DateTypes.DateTime}})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(G)))(a||G)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"})}class L extends D{getViewElementConfig(e){return(0,u.Z)(function*(){return null})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(L)))(a||L)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"})}class O extends D{constructor(){super(...arguments),this.type="crt.DataTableEditPhoneCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const n=yield t().call(a,e);if(!e?.context)return n;const r=a.getColumnDataSchemaAttribute(e);return r?{...n,displayAsPhone:r.isMasked}:n})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(O)))(a||O)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"})}class M extends D{constructor(){super(...arguments),this.type="crt.DataTableEditEmailCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){const n=yield t().call(a,e);if(!e?.context)return n;const r=a.getColumnDataSchemaAttribute(e);return r?{...n,isFormatValidated:r.isFormatValidated}:n})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(M)))(a||M)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"})}class $ extends D{constructor(){super(...arguments),this.type="crt.DataTableEditWebCell"}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory($)))(a||$)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:$,factory:$.\u0275fac,providedIn:"root"})}class w extends D{constructor(){super(...arguments),this.type="crt.TableDcmStageEditingCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.Z)(function*(){return{...yield t().call(a,e),column:{},dcmStages:"$DcmStages"}})()}static#e=this.\u0275fac=function(){let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(w)))(a||w)}}();static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"})}const fe="CheckDataGridColumnsRightsOnLoad",Se="DisableDataGridEditingMode",Ie="DisableDataGridMultipleRowsSelection",Ae="CanCreateDefaultGridSettings",ye=[o.DataValueType.Guid,o.DataValueType.Text,o.DataValueType.Integer,o.DataValueType.Float,o.DataValueType.Money,o.DataValueType.DateTime,o.DataValueType.Date,o.DataValueType.Time,o.DataValueType.Lookup,o.DataValueType.Enum,o.DataValueType.Boolean,o.DataValueType.SHORT_TEXT,o.DataValueType.MEDIUM_TEXT,o.DataValueType.MAXSIZE_TEXT,o.DataValueType.LONG_TEXT,o.DataValueType.FLOAT1,o.DataValueType.FLOAT2,o.DataValueType.FLOAT3,o.DataValueType.FLOAT4,o.DataValueType.FLOAT8,o.DataValueType.PHONE_TEXT,o.DataValueType.WEB_TEXT,o.DataValueType.EMAIL_TEXT];class q{constructor(e,t,a){this._cellViewConfigCreatorFactory=e,this._rightsService=t,this._featureService=a}_getColumnName(e){return e.dataValueType===o.DataValueType.Lookup?`${e.path}Id`:e.path}_getColumnsAccessRights(e){const t=(0,E.uniq)(e.attributes.map(this._getColumnName));return this._featureService.getFeatureState(fe).pipe((0,g.switchMap)(n=>n?this._requestColumnsAccessRights(e.name,t):this._allowColumnsAccessRights(t)))}_allowColumnsAccessRights(e){const t={};return e.forEach(a=>t[a]=!0),(0,m.of)(t)}_requestColumnsAccessRights(e,t){return this._rightsService.getCanEditColumns({schemaName:e,columnNames:t})}_isReadonlyColumn(e,t){const a=this._getColumnName(t),n=!t.isSystem,r=t.attributeType===o.DataSchemaAttributeType.OwnAttribute,s=ye.includes(t.dataValueType);return!(e[a]&&r&&n&&s)}_generateColumnDefinition(e,t,a){const{dataSourceName:n,dataSchema:r,itemsAttributeName:s,viewModel:c,features:d,dataGridName:f}=e,y=t.name,{primaryAttributeName:J,primaryDisplayAttributeName:ce,name:Ne}=r??{},Ge=J&&`${n}_${J}`,Le={columnName:y,dataValueType:t.dataValueType,primaryDisplayAttributeName:ce},Oe={column:{...a,id:(0,o.generateGuid)()},context:c,itemsAttributeName:s,features:d,primaryAttributeName:Ge,primaryDisplayAttributeName:ce,columnName:y,dataGridName:f,dataGridSchemaName:Ne},Me=this._cellViewConfigCreatorFactory.create(Le)?.getViewElementConfig(Oe)??(0,m.of)(null);return(0,m.from)(Me).pipe((0,g.map)($e=>({...a,cellView:$e})))}processDataGridColumnDefinitions(e,t){const{dataSourceName:a,dataSchema:n}=e;return this._getColumnsAccessRights(n).pipe((0,g.switchMap)(r=>{const s=t.map(c=>{const d=n.attributes.find(f=>(0,h.removeSpecialSymbols)(`${a}_${f.name}`)===c.code);return d?(0,E.isUndefined)(c.readonly)?this._generateColumnDefinition(e,d,{...c,readonly:this._isReadonlyColumn(r,d)}):this._generateColumnDefinition(e,d,c):(0,m.of)(c)});return(0,m.forkJoin)(s)}))}getDataGridColumnDefinition(e,t,a){const{dataSchema:n,dataSourceName:r}=e;return this._getColumnsAccessRights(n).pipe((0,g.switchMap)(s=>{const c=`${r}_${t.name}`,d=(0,o.generateGuid)(),f={id:d,code:(0,h.removeSpecialSymbols)(c),caption:a||`#ResourceString(${d.split("-")[0]})#`,dataValueType:t.dataValueType,readonly:this._isReadonlyColumn(s,t)};return this._generateColumnDefinition(e,t,f)}))}static#e=this.\u0275fac=function(t){return new(t||q)(i.\u0275\u0275inject(ae),i.\u0275\u0275inject(ne.RightsService),i.\u0275\u0275inject(ne.FeatureService))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac,providedIn:"root"})}var ve=p(29989),Ve=p.n(ve);class ee extends x{constructor(e,t,a,n,r,s){super(e),this._maskService=t,this._metadataModifier=a,this._schemaPartService=n,this._entitySchemaRepository=r,this._dataGridActiveFolderDesignSettingsProvider=s}_getResourcesFromProfile(){var e=this;return(0,u.Z)(function*(){const[,t]=yield e._schemaPartService.use("USER"),a=yield t.loadResources();return{strings:(0,E.cloneDeep)(a?.localizableStrings)}})()}_getResourcesFromActiveFolderSettings(e,t){var a=this;return(0,u.Z)(function*(){const n=yield a._dataGridActiveFolderDesignSettingsProvider.get({viewConfig:e,viewModel:t,metadata:a.schemaService.schema});return{strings:(0,E.cloneDeep)(n?.resources?.localizableStrings??{})}})()}getResources(e,t){var a=this;return(0,u.Z)(function*(){const n=yield a._getResourcesFromProfile(),r=yield a._getResourcesFromActiveFolderSettings(e,t);return Ve()(n,r)})()}getEntitySchemaNameByPath(e,t){const a=t.split("."),n=this._entitySchemaRepository.findEntitySchemaByPath(e,a);return Promise.resolve(n?.name)}setColumnCaptionResources(e,t,a){const n=this._metadataModifier.revert((0,E.cloneDeep)(e)),r=(0,h.extractResourcesKey)(n.caption);!r||(e.captionResources=(0,h.toLocalizableStringsArray)(t.strings,r))}processColumns(e,t,a){return this._maskService.showBodyMask(),super.processColumns(e,t,a)}onColumnPreparationFinished(){this._maskService.hideBodyMask()}static#e=this.\u0275fac=function(t){return new(t||ee)(i.\u0275\u0275inject(i.Injector),i.\u0275\u0275inject(o.MaskService),i.\u0275\u0275inject(U.MetadataModifierService),i.\u0275\u0275inject(P.SchemaPartsService),i.\u0275\u0275inject(h.EntitySchemaRepository),i.\u0275\u0275inject(_.DataGridActiveFolderDesignSettingsProvider))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:ee,factory:ee.\u0275fac})}class te{constructor(e){this._columnSelectionService=e}_canSelectColumns(e){if(e===null)return(0,m.of)(!1);const t={type:"crt.CanDiscardUnsavedDataRequest",$context:e},a=o.HandlerChainService.instance.process(t);return(0,m.from)(a)}_getDataGridCollection(e,t){const a=e.get(T.VIEW_ELEMENT_CONFIG),n=(0,_.getViewModelItemsAttributeName)(a);return n?(0,m.from)(t[n]).pipe((0,g.map)(r=>r)):(0,m.of)(null)}selectColumns(e){return e.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.switchMap)(t=>this._getDataGridCollection(e,t)),(0,g.switchMap)(t=>this._canSelectColumns(t)),(0,g.switchMap)(t=>(0,m.iif)(()=>t,this._columnSelectionService.selectColumns(e),(0,m.of)([]))),(0,g.take)(1))}static#e=this.\u0275fac=function(t){return new(t||te)(i.\u0275\u0275inject(_.DataGridColumnSelectionService))};static#t=this.\u0275prov=i.\u0275\u0275defineInjectable({token:te,factory:te.\u0275fac})}const Fe=se.FactoryProvider.create({token:ae,mappings:[{predicate:({columnName:l,primaryDisplayAttributeName:e})=>Boolean(l)&&l===e,injectable:Z},{predicate:({dataValueType:l})=>l===o.DataValueType.Lookup,injectable:H},{predicate:({dataValueType:l})=>l===o.DataValueType.Boolean,injectable:X},{predicate:({dataValueType:l})=>l===o.DataValueType.PHONE_TEXT,injectable:S},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT,injectable:I},{predicate:({dataValueType:l})=>l===o.DataValueType.RICH_TEXT,injectable:V},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT||l===o.DataValueType.WEB_TEXT,injectable:z},{predicate:({dataValueType:l,columnName:e})=>l===o.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:F}]}),be=se.FactoryProvider.create({token:pe,mappings:[{predicate:({dataValueType:l})=>h.DATE_TIME_DATA_VALUE_TYPES.includes(l),injectable:G},{predicate:({dataValueType:l})=>h.NUMERIC_DATA_VALUE_TYPES.includes(l),injectable:R},{predicate:({dataValueType:l})=>l===o.DataValueType.Lookup,injectable:N},{predicate:({dataValueType:l})=>l===o.DataValueType.Boolean,injectable:L},{predicate:({dataValueType:l})=>l===o.DataValueType.PHONE_TEXT,injectable:O},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT,injectable:M},{predicate:({dataValueType:l})=>l===o.DataValueType.WEB_TEXT,injectable:$},{predicate:({dataValueType:l,columnName:e})=>l===o.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:w}],default:{injectable:b}}),Re=se.FactoryProvider.create({token:he,mappings:[{predicate:({columnName:l,primaryDisplayAttributeName:e})=>l&&l===e,injectable:A},{predicate:({columnName:l})=>l&&l==="Size",injectable:v}]});var Y=p(74742);let le=class extends o.BaseRequest{constructor(){super(...arguments),this.type="crt.DataGridCancelItemsChangesRequest"}};le=(0,Y.__decorate)([(0,o.CrtRequest)({type:"crt.DataGridCancelItemsChangesRequest"})],le);let re=class extends o.BaseRequestHandler{constructor(e){super(),this._schemaService=e}_canCancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const{$context:a,itemsAttributeName:n,changedItems:r}=e;if(!a||!n)return!1;if(r&&r.length>0)return!0;const s=yield a[n],c={type:"crt.CanDiscardUnsavedDataRequest",$context:s};return yield t.handlerChain.process(c)})()}_cancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const a={type:"crt.CancelRecordsChangesRequest",$context:e.$context,recordIds:e.changedItems,itemsAttributeName:e.itemsAttributeName};return yield t.handlerChain.process(a)})()}_getDataGridViewConfigs(e){return this._schemaService.getViewConfigInfoByFilter(t=>{const{type:a,items:n}=t;return a==="crt.DataGrid"&&n===`$${e}`}).map(t=>t.viewConfig)}_cleanupSelectionState(e,t){const a=this._getDataGridViewConfigs(e).map(n=>n?._selectionOptions?.attribute||(0,_.createDataGridSelectionStateAttributeName)(n)).map(n=>this.handlerChain.process({type:"crt.ChangeViewModelAttributeValueRequest",$context:t,attributeName:n,attributeValue:null}));return Promise.all(a)}handle(e){var t=this;return(0,u.Z)(function*(){return e?(yield t._canCancelItemsChanges(e))?t._cancelItemsChanges(e):(yield t._cleanupSelectionState(e.itemsAttributeName,e.$context),!1):!1})()}};re=(0,Y.__decorate)([(0,o.CrtRequestHandler)({type:"crt.DataGridCancelItemsChangesHandler",requestType:"crt.DataGridCancelItemsChangesRequest"}),(0,Y.__metadata)("design:paramtypes",[P.SchemaService])],re);let ue=class extends o.BaseRequest{};ue=(0,Y.__decorate)([(0,o.CrtRequest)({type:"crt.DataGridRowDoubleClickRequest"})],ue);let ie=class extends o.BaseRequestHandler{_isClickByNewRecord(e){return(0,u.Z)(function*(){const{itemsAttributeName:t,rowId:a}=e;return!t||!a?!1:(yield(yield e.$context[t])?.findByPrimaryAttribute(a))?.getPrimaryModelMode()===h.ModelMode.Create})()}_createUpdateRecordRequest(e){return{type:"crt.UpdateRecordRequest",$context:e.$context,recordId:e.rowId,itemsAttributeName:e.itemsAttributeName}}handle(e){var t=this;return(0,u.Z)(function*(){return(yield t._isClickByNewRecord(e))?Promise.resolve():t.handlerChain.process(t._createUpdateRecordRequest(e))})()}};ie=(0,Y.__decorate)([(0,o.CrtRequestHandler)({requestType:"crt.DataGridRowDoubleClickRequest",type:"crt.DataGridRowDoubleClickHandler"})],ie);var Ce=p(31134);let oe=class de{static#e=this.\u0275fac=function(t){return new(t||de)};static#t=this.\u0275mod=i.\u0275\u0275defineNgModule({type:de});static#a=this.\u0275inj=i.\u0275\u0275defineInjector({imports:[Ce.CommonModule]})};oe=(0,Y.__decorate)([(0,o.CrtModule)({requestHandlers:[re,ie]})],oe),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.\u0275\u0275setNgModuleScope(oe,{imports:[Ce.CommonModule]})}()}}]);
